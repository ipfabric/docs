variables:
  GIT_SSH_COMMAND: "ssh -o StrictHostKeyChecking=no -i .ssh/gitlab-ci"
  GIT_STRATEGY: clone

image: python

build_main_pages:
  stage: deploy
  only:
    - main
  before_script:
    - git config --global user.email "devops+gl_ci_bot@ipfabric.io"
    - git config --global user.name "ci_bot"
    - mkdir -pvm 0700 .ssh
    - echo "$ssh_deploy_key" > .ssh/gitlab-ci
    - chmod 0400 .ssh/gitlab-ci
    - git remote set-url origin "$(perl -pe 's#.*@(.+?(\:\d+)?)/#git@\1:#' <<< $CI_REPOSITORY_URL)"
  script:
    - pip install -r requirements.txt
    - git fetch origin gh-pages --depth=1
    - mike deploy --push main

strict_build_mr:
  stage: test
  only:
    - merge_requests
  script:
    - export DOC_TARGET=`mktemp -d`
    - pip install -r requirements.txt
    - mkdocs build -d "$DOC_TARGET" --strict
    - rm -rf "$DOC_TARGET"
