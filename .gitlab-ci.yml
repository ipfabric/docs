variables:
  GIT_SSH_COMMAND: "ssh -o StrictHostKeyChecking=no -i .ssh/gitlab-ci"
  GIT_STRATEGY: clone
  VALE_RELEASE: "https://github.com/errata-ai/vale/releases/download/v2.15.5/vale_2.15.5_Linux_64-bit.tar.gz"

image: python

build_main_pages:
  stage: deploy
  only:
    - main
  before_script:
    - git config --global user.email "devops+gl_ci_bot@ipfabric.io"
    - git config --global user.name "ci_bot"
    - mkdir -pvm 0700 .ssh
    - echo "$ssh_deploy_key" > .ssh/gitlab-ci
    - chmod 0400 .ssh/gitlab-ci
    - git remote set-url origin "$(perl -pe 's#.*@(.+?(\:\d+)?)/#git@\1:#' <<< $CI_REPOSITORY_URL)"
  script:
    - pip install -r requirements.txt
    - git fetch origin gh-pages --depth=1
    - cat main_preamble.md docs/index.md > docs/index.md.tmp && mv docs/index.md.tmp docs/index.md
    - mike deploy --push main

strict_build_mr:
  stage: test
  only:
    - merge_requests
  script:
    - export DOC_TARGET=`mktemp -d`
    - pip install -r requirements.txt
    - mkdocs build -d "$DOC_TARGET" --strict
    - rm -rf "$DOC_TARGET"

vale_mr:
  stage: test
  only:
    - merge_requests
  allow_failure: true
  script:
    - curl --fail -L -o /tmp/vale.tar.gz "$VALE_RELEASE"
    - tar -C /tmp -zxvf /tmp/vale.tar.gz
    - /tmp/vale docs
